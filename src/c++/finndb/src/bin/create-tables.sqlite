CREATE TABLE movements (
       id STRING UNIQUE PRIMARY KEY,
       date STRING,
       asset STRING,
       account STRING,
       bank STRING,
       amount INTEGER,
       decimals INTEGER,
       trans_id STRING,
       FOREIGN KEY(trans_id) REFERENCES transactions(id));

CREATE TABLE transactions (
       id STRING UNIQUE PRIMARY KEY,
       date STRING,
       raw STRING);

CREATE TABLE valuations (
       date STRING,
       asset STRING,
       amount INTEGER,
       decimals INTEGER,
       PRIMARY KEY(date, asset)
       FOREIGN KEY(asset) REFERENCES asset_to_currency(asset));

CREATE TABLE asset_to_currency (
       asset STRING UNIQUE PRIMARY KEY,
       currency STRING);

/* Views */
CREATE VIEW assets_by_account (account, bank, asset, amount, decimals) AS
  SELECT account, bank, asset, sum(amount) as SUM, 10
  FROM movements
  GROUP BY asset, account
  HAVING SUM != 0;

CREATE VIEW latest_valuations (date, asset, currency, amount, decimals) AS
  SELECT max_dates.date, info.asset, info.currency, val.amount, val.decimals FROM

  (
    SELECT MAX(date) AS date, asset FROM valuations
    GROUP BY asset
  ) AS max_dates

  INNER JOIN valuations AS val
  ON val.date = max_dates.date AND val.asset = max_dates.asset

  INNER JOIN asset_to_currency as info
  ON max_dates.asset = info.asset;

CREATE VIEW current_value
  (value_date, account, bank, asset, amount, rate, currency, value, decimals) AS
  SELECT v.date as value_date, a.account, a.bank, a.asset,
    a.amount/10000000000.0 as amount,
    v.amount/1000000000.0 as rate,
    v.currency,
    CAST((a.amount * v.amount) / 10000000000 AS int) AS value,
    10 as decimals

  FROM assets_by_account AS a

  LEFT JOIN latest_valuations AS v
  ON a.asset = v.asset;

/* Standard values */
INSERT into valuations (date, asset, amount, decimals) VALUES
("2000-01-01", "SEK", 10000000000, 10);
INSERT into valuations (date, asset, amount, decimals) VALUES
("2000-01-01", "NOK", 10000000000, 10);
INSERT into valuations (date, asset, amount, decimals) VALUES
("2000-01-01", "USD", 10000000000, 10);
INSERT into valuations (date, asset, amount, decimals) VALUES
("2000-01-01", "EUR", 10000000000, 10);
